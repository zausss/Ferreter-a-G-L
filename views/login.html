<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferretería G&L - Iniciar Sesión</title>
    <link rel="stylesheet" href="/css/login.css">
</head>
<body>
    <div class="contenedor-login">
        <div class="encabezado-login">
            <img src="/img/logo.jpg" alt="Logo Ferretería G&L" class="logo-login"> 
            <h2>Ferretería G&L</h2>
            <p>Sistema de Gestión</p>
        </div>
        
        <!-- Div para mostrar mensajes de error o éxito -->
        <div id="mensaje-login" class="mensaje" style="display: none;"></div>
        
        <form class="formulario-login" action="/auth/login" method="POST" id="form-login">
            <div class="grupo-entrada">
                <label for="email_usuario">Email o Usuario:</label>
                <input type="text" id="email_usuario" name="email_usuario" required  placeholder="Ingresa tu email o usuario">
            </div>

            <div class="grupo-entrada">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" name="password" required placeholder="Ingresa tu contraseña">
                <p>¿Olvidaste tu contraseña? <a href="recuperar.html">Recupérala aquí</a></p>
            </div>

            <button type="submit" class="boton-login">Iniciar Sesión</button>
        </form>

        <div class="pie-login">
            <p>¿No tienes cuenta? <a href="registro.html">Regístrate aquí</a></p>
        </div>
    </div>

    <script>
        // Obtener referencias a elementos del DOM
        const formLogin = document.getElementById('form-login');
        const mensajeDiv = document.getElementById('mensaje-login');
        const botonSubmit = formLogin.querySelector('.boton-login');

        // Función para mostrar mensajes
        function mostrarMensaje(mensaje, esError = true) {
            mensajeDiv.textContent = mensaje;
            mensajeDiv.className = esError ? 'mensaje error' : 'mensaje exito';
            mensajeDiv.style.display = 'block';
            
            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                mensajeDiv.style.display = 'none';
            }, 5000);
        }

        // Interceptar el envío del formulario
        formLogin.addEventListener('submit', async function(evento) {
            // PASO CLAVE: Prevenir envío normal del formulario
            evento.preventDefault();
            
            // Obtener datos del formulario
            const formData = new FormData(formLogin);
            const datosLogin = {
                email_usuario: formData.get('email_usuario'),
                password: formData.get('password')
            };

            // Cambiar texto del botón mientras procesa
            const textoOriginal = botonSubmit.textContent;
            botonSubmit.textContent = 'Iniciando sesión...';
            botonSubmit.disabled = true;

            try {
                // Hacer petición AJAX al servidor
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(datosLogin)
                });

                // Leer la respuesta JSON
                const resultado = await response.json();

                if (resultado.exito) {
                    // Login exitoso
                    mostrarMensaje('Login exitoso. Redirigiendo...', false);
                    
                    // Redirigir después de 1 segundo
                    setTimeout(() => {
                        window.location.href = resultado.redirectTo || '/dashboard';
                    }, 1000);
                    
                } else {
                    // Error en login
                    mostrarMensaje(resultado.mensaje);
                }

            } catch (error) {
                // Error de conexión o del servidor
                mostrarMensaje('Error de conexión. Intenta nuevamente.');
                console.error('Error:', error);
            } finally {
                // Restaurar botón
                botonSubmit.textContent = textoOriginal;
                botonSubmit.disabled = false;
            }
        });
    </script>
</body>
</html>