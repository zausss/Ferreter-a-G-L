<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categor√≠as</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/categorias.css">
</head>
<body>
    <div class="contenedor-principal">
        <aside class="barra-lateral">
            <div class="encabezado-barra-lateral">
                <img src="/img/logo.jpg" alt="Logo Ferreter√≠a J&L" class="logo">
                </div>
            <nav class="navegacion-barra-lateral">
                <ul>
                    <li>
                        <a href="menu.html" class="item-navegacion activo">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
                            <span>Inicio</span>
                        </a>
                    </li>




                    <li class="tiene-submenu">
                        <a href="#" class="item-navegacion" data-submenu="inventario">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M200-640v440h560v-440H640v320l-160-80-160 80v-320H200Zm0 520q-33 0-56.5-23.5T120-200v-499q0-14 4.5-27t13.5-24l50-61q11-14 27.5-21.5T250-840h460q18 0 34.5 7.5T772-811l50 61q9 11 13.5 24t4.5 27v499q0 33-23.5 56.5T760-120H200Zm16-600h528l-34-40H250l-34 40Zm184 80v190l80-40 80 40v-190H400Zm-200 0h560-560Z"/></svg>
                            <span>Inventario</span>
                            <span class="icono-adicional">+</span>
                        </a>
                        <ul class="submenu" id="submenu-inventario">
                            <li><a href="categorias.html">Categor√≠as</a></li>
                            <li><a href="#">Productos</a></li>
                            <li><a href="#">Control de Stock</a></li>
                        </ul>
                    </li>
                    



                        <li class="tiene-submenu">
                        <a href="#" class="item-navegacion">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M200-200v-560 560Zm0 80q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v100h-80v-100H200v560h560v-100h80v100q0 33-23.5 56.5T760-120H200Zm320-160q-33 0-56.5-23.5T440-360v-240q0-33 23.5-56.5T520-680h280q33 0 56.5 23.5T880-600v240q0 33-23.5 56.5T800-280H520Zm280-80v-240H520v240h280Zm-160-60q25 0 42.5-17.5T700-480q0-25-17.5-42.5T640-540q-25 0-42.5 17.5T580-480q0 25 17.5 42.5T640-420Z"/></svg>
                            <span>Ventas</span>
                            <span class="icono-adicional">+</span>
                        </a>
                        <ul class="submenu" id="submenu-ventas">
                            <li><a href="">Nuevas Ventas</a></li>
                            <li><a href="">Resumen Ventas</a></li>
                        </ul>
                    </li>
                    

                    <li>
                        <a href="clientes.html" class="item-navegacion">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M185-80q-17 0-29.5-12.5T143-122v-105q0-90 56-159t144-88q-40 28-62 70.5T259-312v190q0 11 3 22t10 20h-87Zm147 0q-17 0-29.5-12.5T290-122v-190q0-70 49.5-119T459-480h189q70 0 119 49t49 119v64q0 70-49 119T648-80H332Zm148-484q-66 0-112-46t-46-112q0-66 46-112t112-46q66 0 112 46t46 112q0 66-46 112t-112 46Z"/></svg>
                            <span>Clientes</span>
                        </a>
                    </li>
                
                
                    <li class="tiene-submenu">
                        <a href="#" class="item-navegacion">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M411-480q-28 0-46-21t-13-49l12-72q8-43 40.5-70.5T480-720q44 0 76.5 27.5T597-622l12 72q5 28-13 49t-46 21H411Zm24-80h91l-8-49q-2-14-13-22.5t-25-8.5q-14 0-24.5 8.5T443-609l-8 49ZM124-441q-23 1-39.5-9T63-481q-2-9-1-18t5-17q0 1-1-4-2-2-10-24-2-12 3-23t13-19l2-2q2-19 15.5-32t33.5-13q3 0 19 4l3-1q5-5 13-7.5t17-2.5q11 0 19.5 3.5T208-626q1 0 1.5.5t1.5.5q14 1 24.5 8.5T251-596q2 7 1.5 13.5T250-570q0 1 1 4 7 7 11 15.5t4 17.5q0 4-6 21-1 2 0 4l2 16q0 21-17.5 36T202-441h-78Zm676 1q-33 0-56.5-23.5T720-520q0-12 3.5-22.5T733-563l-28-25q-10-8-3.5-20t18.5-12h80q33 0 56.5 23.5T880-540v20q0 33-23.5 56.5T800-440ZM0-240v-63q0-44 44.5-70.5T160-400q13 0 25 .5t23 2.5q-14 20-21 43t-7 49v65H0Zm240 0v-65q0-65 66.5-105T480-450q108 0 174 40t66 105v65H240Zm560-160q72 0 116 26.5t44 70.5v63H780v-65q0-26-6.5-49T754-397q11-2 22.5-2.5t23.5-.5Zm-320 30q-57 0-102 15t-53 35h311q-9-20-53.5-35T480-370Zm0 50Zm1-280Z"/></svg>
                            <span>Proveedores</span>
                            <span class="icono-adicional">+</span>
                        </a>
                        <ul class="submenu" id="submenu-proveedores">
                            <li><a href="proveedores.html">Lista de Proveedores</a></li>
                            <li><a href="nuevo-proveedor.html">Nuevo Proveedor</a></li>
                        </ul>
                    </li>
                    






                    <li class="tiene-submenu">
                        <a href="#" class="item-navegacion">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M320-480v-80h320v80H320Zm0-160v-80h320v80H320Zm-80 240h300q29 0 54 12.5t42 35.5l84 110v-558H240v400Zm0 240h442L573-303q-6-8-14.5-12.5T540-320H240v160Zm480 80H240q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h480q33 0 56.5 23.5T800-800v640q0 33-23.5 56.5T720-80Zm-480-80v-640 640Zm0-160v-80 80Z"/></svg>
                            <span>Reportes</span>
                            <span class="icono-adicional">+</span>
                        </a>
                        <ul class="submenu" id="submenu-reportes">
                            <li><a href="reporte-ventas.html">Reporte de Ventas</a></li>
                            <li><a href="reporte-inventario.html">Reporte de Inventario</a></li>
                            <li><a href="reporte-financiero.html">Reporte Financiero</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="pie-barra-lateral">
                <a href="#" class="item-navegacion">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="m234-480-12-60q-12-5-22.5-10.5T178-564l-58 18-40-68 46-40q-2-13-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T222-820l12-60h80l12 60q12 5 22.5 10.5T370-796l58-18 40 68-46 40q2 13 2 26t-2 26l46 40-40 68-58-18q-11 8-21.5 13.5T326-540l-12 60h-80Zm40-120q33 0 56.5-23.5T354-680q0-33-23.5-56.5T274-760q-33 0-56.5 23.5T194-680q0 33 23.5 56.5T274-600ZM592-40l-18-84q-17-6-31.5-14.5T514-158l-80 26-56-96 64-56q-2-18-2-36t2-36l-64-56 56-96 80 26q14-11 28.5-19.5T574-516l18-84h112l18 84q17 6 31.5 14.5T782-482l80-26 56 96-64 56q2 18 2 36t-2 36l64 56-56 96-80-26q-14 11-28.5 19.5T722-124l-18 84H592Zm56-160q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Z"/></svg>
                    <span>Configuraci√≥n</span>
                </a>
                
                <!-- Bot√≥n de Cerrar Sesi√≥n -->
                <a href="/auth/logout" class="item-navegacion" id="cerrar-sesion" onclick="confirmarCerrarSesion(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#d32f2f">
                        <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/>
                    </svg>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </div>
        </aside>


        <!-- √°rea de contenido de la pagina -->
        <main class="area-contenido">
            <div class="categorias-container">
                <!-- Header -->
                <div class="categorias-header">
                    <h1>Gesti√≥n de Categor√≠as</h1>
                    <button class="btn-nueva-categoria" onclick="abrirModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                        </svg>
                        Nueva Categor√≠a
                    </button>
                </div>

                <!-- Stats -->
                <div class="categorias-stats">
                    <div class="stat-card">
                        <h3 class="stat-numero" id="total-categorias">0</h3>
                        <p class="stat-label">Total Categor√≠as</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-numero" id="categorias-activas">0</h3>
                        <p class="stat-label">Categor√≠as Activas</p>
                    </div>
                </div>

                <!-- Barra de b√∫squeda -->
                <div class="busqueda-container">
                    <input 
                        type="text" 
                        placeholder="Buscar categor√≠as..." 
                        class="campo-busqueda" 
                        id="campo-busqueda"
                        onkeyup="buscarCategorias()"
                    >
                    <svg class="icono-busqueda" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
                    </svg>
                </div>

                <!-- Mensajes -->
                <div class="mensaje-exito" id="mensaje-exito">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                    </svg>
                    <span id="texto-mensaje-exito"></span>
                </div>

                <div class="mensaje-error" id="mensaje-error">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" />
                    </svg>
                    <span id="texto-mensaje-error"></span>
                </div>

                <!-- Tabla de categor√≠as -->
                <div class="categorias-tabla-container">
                    <div class="loading" id="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>

                    <table class="categorias-tabla" id="tabla-categorias">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Estado</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpo-tabla-categorias">
                            <!-- Las categor√≠as se cargar√°n aqu√≠ din√°micamente -->
                        </tbody>
                    </table>

                    <!-- Estado vac√≠o -->
                    <div class="estado-vacio" id="estado-vacio" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                        </svg>
                        <h3>No hay categor√≠as</h3>
                        <p>A√∫n no has creado ninguna categor√≠a. ¬°Crea tu primera categor√≠a!</p>
                        <button class="btn-nueva-categoria" onclick="abrirModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                            </svg>
                            Crear Primera Categor√≠a
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal para crear/editar categor√≠a -->
        <div class="modal-categoria" id="modal-categoria">
            <div class="modal-contenido">
                <div class="modal-header">
                    <h2 class="modal-titulo" id="titulo-modal">Nueva Categor√≠a</h2>
                    <button class="btn-cerrar-modal" onclick="cerrarModal()">&times;</button>
                </div>

                <form class="formulario-categoria" id="formulario-categoria">
                    <div class="grupo-campo">
                        <label class="etiqueta-campo" for="codigo-categoria">C√≥digo *</label>
                        <input 
                            type="text" 
                            id="codigo-categoria" 
                            name="codigo_categoria" 
                            class="campo-formulario"
                            placeholder="Ej: HER, PIN, ELE" 
                            maxlength="10"
                            required
                        >
                    </div>

                    <div class="grupo-campo">
                        <label class="etiqueta-campo" for="nombre-categoria">Nombre *</label>
                        <input 
                            type="text" 
                            id="nombre-categoria" 
                            name="nombre_categoria" 
                            class="campo-formulario"
                            placeholder="Ej: Herramientas, Pinturas, El√©ctricos" 
                            maxlength="100"
                            required
                        >
                    </div>

                    <div class="grupo-campo">
                        <label class="etiqueta-campo" for="descripcion-categoria">Descripci√≥n</label>
                        <textarea 
                            id="descripcion-categoria" 
                            name="descripcion" 
                            class="campo-formulario campo-textarea"
                            placeholder="Descripci√≥n opcional de la categor√≠a..."
                            maxlength="500"
                        ></textarea>
                    </div>

                    <div class="botones-formulario">
                        <button type="button" class="btn-cancelar" onclick="cerrarModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-guardar" id="btn-guardar">
                            Guardar Categor√≠a
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <script src="/js/menu.js"></script>
        <script src="/js/dashboard.js"></script>
        <script>
            // ==========================================
            // GESTI√ìN DE CATEGOR√çAS - JavaScript
            // ==========================================

            let categorias = [];
            let categoriaEditando = null;
            let timeoutBusqueda = null;

            // Cargar categor√≠as al iniciar la p√°gina
            document.addEventListener('DOMContentLoaded', function() {
                cargarCategorias();
            });

            // ==========================================
            // FUNCIONES DE CARGA DE DATOS
            // ==========================================

            async function cargarCategorias() {
                try {
                    mostrarLoading(true);
                    
                    const response = await fetch('/api/categorias', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        },
                        credentials: 'include' // Importante: incluir cookies
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            // No autenticado, redirigir al login
                            window.location.href = '/auth/login';
                            return;
                        }
                        throw new Error('Error al cargar categor√≠as');
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        categorias = data.categorias;
                        mostrarCategorias(categorias);
                        actualizarEstadisticas();
                    } else {
                        mostrarError('Error al cargar las categor√≠as');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    mostrarError('Error al conectar con el servidor');
                } finally {
                    mostrarLoading(false);
                }
            }

            // ==========================================
            // FUNCIONES DE INTERFAZ
            // ==========================================

            function mostrarCategorias(listaCategorias) {
                const cuerpoTabla = document.getElementById('cuerpo-tabla-categorias');
                const estadoVacio = document.getElementById('estado-vacio');
                const tabla = document.getElementById('tabla-categorias');

                if (listaCategorias.length === 0) {
                    tabla.style.display = 'none';
                    estadoVacio.style.display = 'block';
                    return;
                }

                tabla.style.display = 'table';
                estadoVacio.style.display = 'none';

                cuerpoTabla.innerHTML = '';

                listaCategorias.forEach(categoria => {
                    const fila = document.createElement('tr');
                    const fechaCreacion = new Date(categoria.fecha_creacion).toLocaleDateString('es-CO');
                    
                    fila.innerHTML = `
                        <td>
                            <span class="codigo-categoria">${categoria.codigo_categoria}</span>
                        </td>
                        <td>
                            <span class="nombre-categoria">${categoria.nombre_categoria}</span>
                        </td>
                        <td>
                            <span class="descripcion-categoria" title="${categoria.descripcion || 'Sin descripci√≥n'}">
                                ${categoria.descripcion || 'Sin descripci√≥n'}
                            </span>
                        </td>
                        <td>
                            <span class="${categoria.activo ? 'estado-activo' : 'estado-inactivo'}">
                                ${categoria.activo ? 'Activa' : 'Inactiva'}
                            </span>
                        </td>
                        <td>
                            <span class="fecha-categoria">${fechaCreacion}</span>
                        </td>
                        <td>
                            <div class="acciones-categoria">
                                <button class="btn-accion btn-ver" onclick="verCategoria(${categoria.id})" title="Ver detalles">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                                        <path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button class="btn-accion btn-editar" onclick="editarCategoria(${categoria.id})" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
                                        <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
                                    </svg>
                                </button>
                                <button class="btn-accion btn-eliminar" onclick="eliminarCategoria(${categoria.id}, '${categoria.nombre_categoria}')" title="Eliminar">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    cuerpoTabla.appendChild(fila);
                });
            }

            function actualizarEstadisticas() {
                const totalCategorias = categorias.length;
                const categoriasActivas = categorias.filter(c => c.activo).length;
                
                document.getElementById('total-categorias').textContent = totalCategorias;
                document.getElementById('categorias-activas').textContent = categoriasActivas;
            }

            // ==========================================
            // FUNCIONES DE MODAL
            // ==========================================

            function abrirModal(categoria = null) {
                const modal = document.getElementById('modal-categoria');
                const titulo = document.getElementById('titulo-modal');
                const formulario = document.getElementById('formulario-categoria');
                
                categoriaEditando = categoria;
                
                if (categoria) {
                    // Modo edici√≥n
                    titulo.textContent = 'Editar Categor√≠a';
                    document.getElementById('codigo-categoria').value = categoria.codigo_categoria;
                    document.getElementById('nombre-categoria').value = categoria.nombre_categoria;
                    document.getElementById('descripcion-categoria').value = categoria.descripcion || '';
                } else {
                    // Modo creaci√≥n
                    titulo.textContent = 'Nueva Categor√≠a';
                    formulario.reset();
                }
                
                modal.classList.add('mostrar');
                document.getElementById('codigo-categoria').focus();
            }

            function cerrarModal() {
                const modal = document.getElementById('modal-categoria');
                modal.classList.remove('mostrar');
                categoriaEditando = null;
                
                // Limpiar formulario
                document.getElementById('formulario-categoria').reset();
            }

            // ==========================================
            // FUNCIONES DE ACCIONES
            // ==========================================

            async function verCategoria(id) {
                const categoria = categorias.find(c => c.id === id);
                if (categoria) {
                    alert(`Categor√≠a: ${categoria.nombre_categoria}\nC√≥digo: ${categoria.codigo_categoria}\nDescripci√≥n: ${categoria.descripcion || 'Sin descripci√≥n'}\nFecha de creaci√≥n: ${new Date(categoria.fecha_creacion).toLocaleDateString('es-CO')}`);
                }
            }

            function editarCategoria(id) {
                const categoria = categorias.find(c => c.id === id);
                if (categoria) {
                    abrirModal(categoria);
                }
            }

            async function eliminarCategoria(id, nombre) {
                console.log('üóëÔ∏è Frontend: Intentando eliminar ID:', id, 'Nombre:', nombre);
                
                if (confirm(`¬øEst√°s seguro de que deseas eliminar la categor√≠a "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                    try {
                        console.log('üì° Frontend: Enviando DELETE a:', `/api/categorias/${id}`);
                        
                        const response = await fetch(`/api/categorias/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'include' // Importante: incluir cookies
                        });

                        console.log('üì® Frontend: Response status:', response.status);

                        if (response.status === 401) {
                            window.location.href = '/auth/login';
                            return;
                        }

                        const data = await response.json();
                        console.log('üìã Frontend: Response data:', data);

                        if (data.success) {
                            mostrarExito(data.message);
                            cargarCategorias();
                        } else {
                            mostrarError(data.message);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Frontend Error:', error);
                        mostrarError('Error al eliminar la categor√≠a');
                    }
                }
            }

            // ==========================================
            // MANEJO DE FORMULARIO
            // ==========================================

            document.getElementById('formulario-categoria').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const btnGuardar = document.getElementById('btn-guardar');
                const datosFormulario = new FormData(this);
                
                const categoria = {
                    codigo_categoria: datosFormulario.get('codigo_categoria').trim().toUpperCase(),
                    nombre_categoria: datosFormulario.get('nombre_categoria').trim(),
                    descripcion: datosFormulario.get('descripcion').trim() || null
                };

                // Validaciones
                if (!categoria.codigo_categoria || !categoria.nombre_categoria) {
                    mostrarError('El c√≥digo y nombre son obligatorios');
                    return;
                }

                if (categoria.codigo_categoria.length > 10) {
                    mostrarError('El c√≥digo no puede tener m√°s de 10 caracteres');
                    return;
                }

                try {
                    btnGuardar.textContent = 'Guardando...';
                    btnGuardar.classList.add('btn-guardando');
                    btnGuardar.disabled = true;

                    const url = categoriaEditando 
                        ? `/api/categorias/${categoriaEditando.id}`
                        : '/api/categorias';
                    
                    const method = categoriaEditando ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include', // Importante: incluir cookies
                        body: JSON.stringify(categoria)
                    });

                    if (response.status === 401) {
                        window.location.href = '/auth/login';
                        return;
                    }

                    const data = await response.json();

                    if (data.success) {
                        mostrarExito(data.message);
                        cerrarModal();
                        cargarCategorias();
                    } else {
                        mostrarError(data.message);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    mostrarError('Error al guardar la categor√≠a');
                } finally {
                    btnGuardar.textContent = categoriaEditando ? 'Actualizar Categor√≠a' : 'Guardar Categor√≠a';
                    btnGuardar.classList.remove('btn-guardando');
                    btnGuardar.disabled = false;
                }
            });

            // ==========================================
            // B√öSQUEDA
            // ==========================================

            function buscarCategorias() {
                const termino = document.getElementById('campo-busqueda').value.toLowerCase();
                
                if (timeoutBusqueda) {
                    clearTimeout(timeoutBusqueda);
                }
                
                timeoutBusqueda = setTimeout(() => {
                    const categoriasFiltradas = categorias.filter(categoria => 
                        categoria.codigo_categoria.toLowerCase().includes(termino) ||
                        categoria.nombre_categoria.toLowerCase().includes(termino) ||
                        (categoria.descripcion && categoria.descripcion.toLowerCase().includes(termino))
                    );
                    
                    mostrarCategorias(categoriasFiltradas);
                }, 300);
            }

            // ==========================================
            // FUNCIONES AUXILIARES
            // ==========================================

            function mostrarLoading(mostrar) {
                const loading = document.getElementById('loading');
                const tabla = document.getElementById('tabla-categorias');
                
                if (mostrar) {
                    loading.style.display = 'flex';
                    tabla.style.display = 'none';
                } else {
                    loading.style.display = 'none';
                    tabla.style.display = 'table';
                }
            }

            function mostrarExito(mensaje) {
                const elemento = document.getElementById('mensaje-exito');
                const texto = document.getElementById('texto-mensaje-exito');
                
                texto.textContent = mensaje;
                elemento.classList.add('mostrar');
                
                setTimeout(() => {
                    elemento.classList.remove('mostrar');
                }, 5000);
            }

            function mostrarError(mensaje) {
                const elemento = document.getElementById('mensaje-error');
                const texto = document.getElementById('texto-mensaje-error');
                
                texto.textContent = mensaje;
                elemento.classList.add('mostrar');
                
                setTimeout(() => {
                    elemento.classList.remove('mostrar');
                }, 5000);
            }

            // Cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                }
            });

            // Cerrar modal al hacer clic fuera
            document.getElementById('modal-categoria').addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModal();
                }
            });

            // Formatear c√≥digo a may√∫sculas mientras se escribe
            document.getElementById('codigo-categoria').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        </script>
</body>
</html>
